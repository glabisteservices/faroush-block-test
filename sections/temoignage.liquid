<style>
  .centre {
    text-align: center
  }
  @media screen and (max-width: 767px) {
    .centre {
      font-size: 2rem;
       text-align: left
    }
  }
  @media screen and (max-width: 479px) {
    .centre {
      font-size: 1.9rem
    }
  }
  .prenom-personne {
    margin-bottom: 20px;
     font-family: Karla;
     color: #6e612b;
     font-size: 1.3rem;
     text-transform: uppercase
  }
  .temoignage-navigation {
    display: flex;
     margin-top: 20px;
     justify-content: space-between;
     align-items: center;
  }
  .slider-container {
    overflow: hidden;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    position: relative;
  }
  .temoignage-slider {
    display: flex;
    transition: transform 0.3s ease-in-out;
    gap: 20px;
    padding-left: calc(50vw - 50%);
  }
  .temoignage-item {
    width: 30%;
    min-width: 300px;
    height: 300px;
    padding: 20px;
    flex-shrink: 0;
    border-radius: 9px;
    background-color: #f5f2d9;
    box-sizing: border-box;
  }
  @media screen and (max-width: 1024px) {
    .temoignage-item {
      width: 45%;
      min-width: 280px;
    }
  }
  @media screen and (max-width: 767px) {
    .temoignage-item {
      width: 70%;
      min-width: 250px;
    }
  }
  @media screen and (max-width: 479px) {
    .temoignage-item {
      width: 70%;
      min-width: 280px;
    }
  }
  .temoignages {
    padding: 20px;
  }
  .heading-style-h1 {
    font-family: Karla;
     color: #6e612b;
     font-size: 2.8rem;
     line-height: 1;
     font-weight: 600;
     margin-bottom: 40px;
  }
  @media screen and (max-width: 767px) {
    .heading-style-h1 {
      font-size: 2.5rem
    }
  }
  .button-4 {
    padding: 1rem 1.75rem;
     border: 1px solid #6e612b;
     border-radius: 0.5rem;
     background-color: transparent;
     transition: background-color 200ms ease;
     font-family: Karla;
     color: #6e612b;
     font-size: 0.9375rem;
     line-height: 1;
     font-weight: 600;
     text-align: center;
     letter-spacing: -0.15px;
     text-transform: uppercase;
     text-decoration: none;
     display: inline-block;
     cursor: pointer;
  }
  .button-4:hover {
    background-color: #6e612b;
    color: white;
  }
  @media screen and (max-width: 479px) {
    .button-4 {
      width: 100%}
  }
  .paragraph {
    font-family: Karla;
     color: #6e612b;
     line-height: 1.5;
  }
  .arrow-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 10px;
    border-radius: 50%;
    transition: background-color 200ms ease;
  }
  .arrow-btn:hover {
    background-color: rgba(110, 97, 43, 0.1);
  }
  .arrow-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    display: none; /* Cache les boutons disabled dans la boucle infinie */
  }
  .arrow-btn img {
    width: 24px;
    height: 24px;
  }
  .precedent img {
    transform: rotate(180deg);
  }
  .arrows {
    display: flex;
    gap: 10px;
  }
</style>

<div class="temoignages">
  {% for block in section.blocks %}
    {% case block.type %}
      {% when '@app' %}
        {% render block %}
      {% when 'titre' %}
        <h1 class="heading-style-h1 centre">
          {{ block.settings.text_heading }}
        </h1>
      {% when 'temoignage-item' %}
        <!-- Les items seront traités dans le slider ci-dessous -->
    {% endcase %}
  {% endfor %}

  {% assign testimonial_blocks = section.blocks | where: 'type', 'temoignage-item' %}
  {% if testimonial_blocks.size > 0 %}
    <div class="slider-container">
      <div class="temoignage-slider" id="temoignage-slider-{{ section.id }}">
        {% for block in testimonial_blocks %}
          <div class="temoignage-item">
            <div class="prenom-personne">
              {{ block.settings.text_text }}
            </div>
            <p class="paragraph">
              {{ block.settings.text_paragraph }}
            </p>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="temoignage-navigation">
      <div class="bouton">
        <a href="{{ section.settings.review_link | default: '#' }}" class="button-4">
          Laissez-nous un avis
        </a>
      </div>
      <div class="arrows">
        <button class="arrow-btn precedent" onclick="moveSlider('{{ section.id }}', -1)">
          <img alt="Précédent" src="https://cdn.prod.website-files.com/689370215f6dcea901024517/689b442bf6f75cb32f16747b_arrow_forward_24dp_6E612B_FILL0_wght400_GRAD0_opsz24.svg" loading="lazy">
        </button>
        <button class="arrow-btn suivant" onclick="moveSlider('{{ section.id }}', 1)">
          <img alt="Suivant" src="https://cdn.prod.website-files.com/689370215f6dcea901024517/689b442bf6f75cb32f16747b_arrow_forward_24dp_6E612B_FILL0_wght400_GRAD0_opsz24.svg" loading="lazy">
        </button>
      </div>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sliders = {};
  
  function initSlider(sectionId) {
    const slider = document.getElementById('temoignage-slider-' + sectionId);
    if (!slider) return;
    
    const items = slider.querySelectorAll('.temoignage-item');
    if (items.length === 0) return;
    
    // Calculer la largeur d'un item en fonction du viewport
    const containerWidth = window.innerWidth;
    let itemWidthPercent;
    
    if (containerWidth > 1024) {
      itemWidthPercent = 30;
    } else if (containerWidth > 767) {
      itemWidthPercent = 45;
    } else {
      itemWidthPercent = 70;
    }
    
    const itemWidth = (containerWidth * itemWidthPercent / 100) + 20; // + gap
    const totalItems = items.length;
    
    sliders[sectionId] = {
      slider: slider,
      currentIndex: 0,
      totalItems: totalItems,
      itemWidth: itemWidth
    };
    
    updateSliderButtons(sectionId);
  }
  
  function updateSliderButtons(sectionId) {
    const sliderData = sliders[sectionId];
    if (!sliderData) return;
    
    // Dans une boucle infinie, les boutons ne sont jamais désactivés
    const prevBtn = document.querySelector(`[onclick*="${sectionId}"][onclick*="-1"]`);
    const nextBtn = document.querySelector(`[onclick*="${sectionId}"][onclick*="1"]`);
    
    if (prevBtn) prevBtn.disabled = false;
    if (nextBtn) nextBtn.disabled = false;
  }
  
  window.moveSlider = function(sectionId, direction) {
    const sliderData = sliders[sectionId];
    if (!sliderData) return;
    
    // Calculer le nouvel index avec boucle infinie
    let newIndex = sliderData.currentIndex + direction;
    
    // Gestion de la boucle infinie
    if (newIndex < 0) {
      newIndex = sliderData.totalItems - 1; // Aller au dernier item
    } else if (newIndex >= sliderData.totalItems) {
      newIndex = 0; // Revenir au premier item
    }
    
    sliderData.currentIndex = newIndex;
    const translateX = -newIndex * sliderData.itemWidth;
    sliderData.slider.style.transform = `translateX(${translateX}px)`;
    
    updateSliderButtons(sectionId);
  };
  
  // Initialize all sliders on page
  const allSliders = document.querySelectorAll('[id^="temoignage-slider-"]');
  allSliders.forEach(slider => {
    const sectionId = slider.id.replace('temoignage-slider-', '');
    initSlider(sectionId);
  });
  
  // Reinitialize on window resize
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(function() {
      allSliders.forEach(slider => {
        const sectionId = slider.id.replace('temoignage-slider-', '');
        initSlider(sectionId);
      });
    }, 250);
  });
});
</script>

{% schema %}
{
  "tag": "section",
  "name": "Témoignages",
  "class": "temoignages",
  "settings": [
    {
      "id": "review_link",
      "type": "url",
      "label": "Lien du bouton avis",
      "info": "URL vers laquelle rediriger quand on clique sur 'Laissez-nous un avis'"
    }
  ],
  "blocks": [
    {
      "name": "Titre",
      "type": "titre",
      "limit": 1,
      "settings": [
        {
          "id": "text_heading",
          "type": "text",
          "label": "Titre",
          "default": "Nos témoignages"
        }
      ]
    },
    {
      "name": "Témoignage",
      "type": "temoignage-item",
      "settings": [
        {
          "id": "text_text",
          "type": "text",
          "label": "Prénom de la personne",
          "default": "Marie D."
        },
        {
          "id": "text_paragraph",
          "type": "textarea",
          "label": "Témoignage",
          "default": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse varius enim in eros elementum tristique. Duis cursus, mi quis viverra ornare, eros dolor interdum nulla, ut commodo diam libero vitae erat."
        }
      ]
    },
    {
      "type": "@app"
    }
  ],
  "presets": [
    {
      "name": "Témoignages",
      "category": "Contenu",
      "blocks": [
        {
          "type": "titre"
        },
        {
          "type": "temoignage-item"
        },
        {
          "type": "temoignage-item"
        },
        {
          "type": "temoignage-item"
        }
      ]
    }
  ]
}
{% endschema %}
